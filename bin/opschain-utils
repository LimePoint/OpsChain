#!/usr/bin/env bash
set -eo pipefail -o nounset

CDPATH='' cd "$(dirname "${BASH_SOURCE[0]}")"
cd ..

if [ $# -eq 0 ]; then
  rake_task="-T '^release:' | sed 's/rake release://'"
else
  rake_task="release:${1}"
fi

eval "$(grep OPSCHAIN_KUBERNETES_NAMESPACE .env)"
exec kubectl exec -n "${OPSCHAIN_KUBERNETES_NAMESPACE}" deploy/opschain-api -- /usr/bin/container_start.sh -c "bundle exec rake ${rake_task}"
